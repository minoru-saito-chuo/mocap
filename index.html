<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mocap Plus | モーションキャプチャ統合解析ツール</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three/examples/js/controls/OrbitControls.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- KaTeX for LaTeX rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>

    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        .loader, .download-loader {
            border: 6px solid #e5e7eb;
            border-radius: 50%;
            border-top: 6px solid #3b82f6;
            width: 50px;
            height: 50px;
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
            animation: fadeIn 0.2s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .nav-link.active {
            background-color: #e2e8f0; /* slate-200 */
            color: #1e293b; /* slate-800 */
        }

        /* Mobile Menu Overlay */
        #mobile-menu-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        #mobile-menu-content {
            transition: transform 0.3s ease-in-out;
        }
        body.mobile-menu-open {
            overflow: hidden;
        }

        #redraw-charts-btn:active {
            transform: scale(0.95);
            transition: transform 0.1s ease-in-out;
        }

        /* macOS like scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* slate-300 */
            border-radius: 20px;
            border: 3px solid #f1f5f9; /* slate-100 */
        }
        .prose-styles h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            padding-bottom: 0.25em;
            border-bottom: 1px solid #e2e8f0;
        }
        .prose-styles h4 {
            font-size: 1.05rem;
            font-weight: 600;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }
        .prose-styles p {
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 1em;
        }
        .prose-styles .formula-block {
            background-color: #f8fafc;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1.5rem 0;
            overflow-x: auto;
            text-align: center;
        }
        .tab-btn.active {
            background-color: #3b82f6;
            color: white;
        }

        /* Range Slider Styling */
        .range-slider-container {
            position: relative;
            height: 60px;
            background-color: #e2e8f0;
            border-radius: 6px;
            margin-top: 20px;
            overflow: hidden;
            cursor: pointer;
            user-select: none;
        }
        .range-slider-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }
        .range-overlay {
            position: absolute;
            top: 0;
            height: 100%;
            background-color: rgba(59, 130, 246, 0.2); /* blue-500 with opacity */
            border-left: 2px solid #2563eb;
            border-right: 2px solid #2563eb;
            z-index: 2;
            cursor: move;
        }
        .range-handle {
            position: absolute;
            top: 0;
            width: 16px;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.5);
            cursor: col-resize;
            z-index: 3;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .range-handle::after {
            content: '';
            width: 2px;
            height: 40%;
            background-color: #64748b;
            border-radius: 1px;
        }
        .range-handle:hover {
            background-color: rgba(255, 255, 255, 0.8);
        }
        .range-handle-left { left: 0; transform: translateX(-50%); }
        .range-handle-right { right: 0; transform: translateX(50%); }
        .unselected-overlay {
            position: absolute;
            top: 0;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.1);
            z-index: 1;
            pointer-events: none;
        }
    </style>
</head>
<body class="antialiased text-slate-700">
    <div id="loading" class="hidden fixed top-0 left-0 w-full h-full bg-white/80 backdrop-blur-sm flex justify-center items-center z-50">
        <div class="text-center"><div class="loader mx-auto"></div><p id="loading-text" class="text-slate-700 mt-4">解析中...</p></div>
    </div>
    <div id="download-overlay" class="hidden fixed top-0 left-0 w-full h-full bg-black/50 backdrop-blur-sm flex justify-center items-center z-50">
         <div class="text-center"><div class="download-loader mx-auto"></div><p class="text-white mt-4">エクスポート用の画像を生成中...</p></div>
    </div>

<div class="flex min-h-screen bg-slate-100">
    <aside class="hidden lg:flex flex-col w-60 bg-slate-200/50 backdrop-blur-xl border-r border-slate-300/50 h-screen sticky top-0">
        <div class="flex items-center justify-center h-16 border-b border-slate-300/50 px-4">
            <img src="icons/icon-192.png" style="width: 25px; height: auto;">
            <h1 class="text-lg font-bold text-slate-800 ml-2">Mocap Plus</h1>
        </div>
        <nav class="flex-1 px-3 py-4 space-y-1 overflow-y-auto">
            <a class="nav-link flex items-center px-3 py-2 text-sm font-medium text-slate-600 hover:bg-slate-200 rounded-md transition-colors duration-150" href="#home">
                <svg class="h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                <span>ホーム</span>
            </a>
            <a class="nav-link flex items-center px-3 py-2 text-sm font-medium text-slate-600 hover:bg-slate-200 rounded-md transition-colors duration-150" href="#data-analysis">
                <svg class="h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 3v18h18"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" d="M18 17V9"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" d="M13 17V5"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" d="M8 17v-3"></path>
                </svg>
                <span>データ解析ツール</span>
            </a>
            <a class="nav-link flex items-center px-3 py-2 text-sm font-medium text-slate-600 hover:bg-slate-200 rounded-md transition-colors duration-150" href="#trimming-tool">
                <svg class="h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M14.121 14.121L19 19m-7-7l7-7m-7 7l-2.879 2.879M12 12L9.121 9.121m0 5.758a3 3 0 10-4.243 4.243 3 3 0 004.243-4.243zm0-5.758a3 3 0 10-4.243-4.243 3 3 0 004.243 4.243z" />
                </svg>
                <span>トリミングツール</span>
            </a>
            <a class="nav-link flex items-center px-3 py-2 text-sm font-medium text-slate-600 hover:bg-slate-200 rounded-md transition-colors duration-150" href="#wide-area-analysis">
                <svg class="h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 0 1 3 16.382V5.618a1 1 0 0 1 1.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0 0 21 18.382V7.618a1 1 0 0 0-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                </svg>
                <span>広域解析ツール</span>
            </a>
            <a class="nav-link flex items-center px-3 py-2 text-sm font-medium text-slate-600 hover:bg-slate-200 rounded-md transition-colors duration-150" href="#standard-velocity">
                <svg class="h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15.6 3.3a10 10 0 1 0 5.7 5.7"></path>
                  <circle cx="12" cy="12" r="2"></circle>
                  <path stroke-linecap="round" stroke-linejoin="round" d="M13.4 10.6 19 5"></path>
                </svg>
                <span>基準速度算出ツール</span>
            </a>
            <div class="pt-4 mt-4 border-t border-slate-300/60">
                <a class="nav-link flex items-center px-3 py-2 text-sm font-medium text-slate-600 hover:bg-slate-200 rounded-md transition-colors duration-150" href="#how-to-use">
                    <svg class="h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="9" stroke-linecap="round" stroke-linejoin="round" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 17h.01" />
                    </svg>
                    <span>使い方ガイド</span>
                </a>
                <a class="nav-link flex items-center px-3 py-2 text-sm font-medium text-slate-600 hover:bg-slate-200 rounded-md transition-colors duration-150" href="#algorithms">
                    <svg class="h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span>アルゴリズム仕様</span>
                </a>
                <a class="nav-link flex items-center px-3 py-2 text-sm font-medium text-slate-600 hover:bg-slate-200 rounded-md transition-colors duration-150" href="#about">
                     <svg class="h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <span>このツールについて</span>
                </a>
            </div>
        </nav>
    </aside>

    <div id="main-content-area" class="flex flex-col flex-1">
         <header class="lg:hidden flex items-center justify-between bg-white/70 backdrop-blur-lg p-4 border-b sticky top-0 z-10">
            <button id="mobile-menu-btn" class="p-2 -ml-2">
                <svg class="h-6 w-6 text-slate-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
            <h1 id="mobile-title" class="text-lg font-semibold text-slate-800">ホーム</h1>
            <div class="w-6"></div> </header>

        <main class="p-4 sm:p-6 md:p-8">
            <div id="home" class="page">
                <div class="max-w-5xl mx-auto">
                    <div class="bg-white p-8 rounded-xl shadow-sm border">
                        <h1 class="text-3xl font-bold text-slate-800 mb-2">Mocap Plus へようこそ</h1>
                        <p class="text-slate-600 mb-8">OptiTrackの解析ソフト「Motive」からエクスポートされたcsvファイルを添付するだけで、モーションキャプチャのデータを簡単に解析することができる統合ツールです。</p>
                        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <a href="#data-analysis" class="nav-card group block bg-slate-50 p-6 rounded-lg border transition-all duration-300 hover:shadow-lg hover:border-blue-300 hover:-translate-y-1">
                                <h2 class="text-xl font-semibold text-slate-800 mb-2">データ解析</h2>
                                <p class="text-slate-600 text-sm">速度、スリップ率などを計算し、グラフで可視化します。</p>
                            </a>
                            <a href="#trimming-tool" class="nav-card group block bg-slate-50 p-6 rounded-lg border transition-all duration-300 hover:shadow-lg hover:border-indigo-300 hover:-translate-y-1">
                                <h2 class="text-xl font-semibold text-slate-800 mb-2">トリミング</h2>
                                <p class="text-slate-600 text-sm">波形を見ながら必要な区間だけを切り出し、CSVで保存します。</p>
                            </a>
                            <a href="#wide-area-analysis" class="nav-card group block bg-slate-50 p-6 rounded-lg border transition-all duration-300 hover:shadow-lg hover:border-purple-300 hover:-translate-y-1">
                                <h2 class="text-xl font-semibold text-slate-800 mb-2">広域解析</h2>
                                <p class="text-slate-600 text-sm">広範囲の移動軌跡とヒートマップを生成し、網羅率を計算します。</p>
                            </a>
                            <a href="#standard-velocity" class="nav-card group block bg-slate-50 p-6 rounded-lg border transition-all duration-300 hover:shadow-lg hover:border-green-300 hover:-translate-y-1">
                                <h2 class="text-xl font-semibold text-slate-800 mb-2">基準速度算出</h2>
                                <p class="text-slate-600 text-sm">車輪の回転周期から基準となる速度を計算します。</p>
                            </a>
                        </div>
                    </div>

                    <div class="mt-10">
                        <h2 class="text-2xl font-bold text-slate-800 mb-4">お知らせ</h2>
                        <div class="space-y-4">
                            <div class="bg-white p-5 rounded-xl shadow-sm border">
                                <p class="text-sm text-slate-500">2025/11/01</p>
                                <p class="font-semibold text-slate-800 mt-1">「トリミングツール」を追加</p>
                                <p class="text-sm text-slate-600 mt-2">X, Y, Z軸の変位グラフを見ながら、データの必要な部分だけを直感的に切り出せるトリミング機能を実装しました。Motive形式でのCSV出力に対応しています。</p>
                            </div>
                            <div class="bg-white p-5 rounded-xl shadow-sm border">
                                <p class="text-sm text-slate-500">2025/10/20</p>
                                <p class="font-semibold text-slate-800 mt-1">「広域解析ツール」を追加</p>
                                <p class="text-sm text-slate-600 mt-2">広範囲の移動軌跡や滞在頻度を可視化するヒートマップ機能、指定範囲に対する網羅率を計算する機能を追加しました。</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TRIMMING TOOL PAGE -->
            <div class="page" id="trimming-tool">
                <div class="max-w-7xl mx-auto space-y-8">
                    <header class="text-center">
                        <h1 class="text-3xl font-bold text-slate-800">データトリミングツール</h1>
                        <p class="text-slate-500 mt-2">グラフを見ながらデータの範囲を選択し、必要な区間だけをCSV形式で保存します。</p>
                    </header>

                    <section class="bg-white p-6 rounded-lg shadow-sm border">
                        <h2 class="text-xl font-semibold text-center mb-6">1. データ入力</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-3xl mx-auto">
                            <div>
                                <label for="csv-file-trimming" class="block text-sm font-medium text-slate-700 mb-2">① CSVファイルを選択</label>
                                <input type="file" id="csv-file-trimming" accept=".csv" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer border rounded-md p-1">
                                <p class="text-xs text-slate-400 mt-1">※MotiveからエクスポートされたCSVファイルのみ対応</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">② 元データの単位 (表示用)</label>
                                <div class="flex items-center space-x-4 mt-2">
                                    <label class="flex items-center">
                                        <input type="radio" name="trim-data-unit" value="mm" class="form-radio" checked>
                                        <span class="ml-2 text-sm">mm (元データがmなら1000倍)</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="trim-data-unit" value="m" class="form-radio">
                                        <span class="ml-2 text-sm">m (そのまま)</span>
                                    </label>
                                </div>
                                <p class="text-xs text-slate-400 mt-1">※グラフのY軸のスケールに影響します。</p>
                            </div>
                        </div>
                    </section>

                    <section id="trimming-editor-section" class="hidden bg-white p-6 rounded-lg shadow-sm border">
                        <h2 class="text-xl font-semibold text-center mb-4">2. 範囲選択</h2>

                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                            <div class="flex items-center gap-4 flex-wrap">
                                <div>
                                    <label for="trimming-body-select" class="block text-sm font-medium text-slate-700 mb-1">表示する剛体</label>
                                    <select id="trimming-body-select" class="block w-48 rounded-md shadow-sm p-1.5 text-sm border-slate-300 focus:ring-1 focus:ring-blue-500 focus:border-blue-500"></select>
                                </div>
                                <div>
                                    <label for="trim-target-points" class="block text-sm font-medium text-slate-700 mb-1" title="グラフ描画時に間引く目標のデータ点数です。">描画データ点数 <span class="text-xs text-slate-400">(ダウンサンプリング)</span></label>
                                    <input type="number" id="trim-target-points" value="1500" step="100" min="100" class="block w-32 rounded-md shadow-sm p-1.5 text-sm border-slate-300 focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>

                            <div class="flex items-center space-x-2 bg-slate-50 p-2 rounded border">
                                <div>
                                    <label class="block text-xs font-medium text-slate-500">開始時間 (s)</label>
                                    <input type="number" id="trim-start-time" class="w-24 p-1 text-sm border-slate-300 rounded shadow-sm" step="0.01">
                                </div>
                                <span class="text-slate-400 font-bold">~</span>
                                <div>
                                    <label class="block text-xs font-medium text-slate-500">終了時間 (s)</label>
                                    <input type="number" id="trim-end-time" class="w-24 p-1 text-sm border-slate-300 rounded shadow-sm" step="0.01">
                                </div>
                            </div>
                        </div>
                        <p class="text-xs text-slate-500 mb-2">※全剛体のデータがトリミング対象になりますが、プレビューには選択した剛体が表示されます。</p>

                        <!-- Main Chart Preview -->
                        <div class="w-full h-80 bg-slate-50 border rounded-lg p-2 relative">
                            <canvas id="trimming-main-chart"></canvas>
                        </div>

                        <!-- Timeline Slider -->
                        <div class="mt-4">
                            <p class="text-sm font-medium text-slate-700 mb-1">タイムライン (ドラッグして範囲を指定)</p>
                            <div id="timeline-slider" class="range-slider-container">
                                <canvas id="timeline-canvas" class="range-slider-canvas"></canvas>
                                <div id="unselected-left" class="unselected-overlay" style="left: 0; width: 0%;"></div>
                                <div id="unselected-right" class="unselected-overlay" style="right: 0; width: 0%;"></div>
                                <div id="range-overlay" class="range-overlay" style="left: 0%; width: 100%;">
                                    <div class="range-handle range-handle-left" title="開始位置"></div>
                                    <div class="range-handle range-handle-right" title="終了位置"></div>
                                </div>
                            </div>
                        </div>

                        <div class="text-center mt-8">
                            <button id="export-trimmed-csv-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-md shadow-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                トリミングしたデータをCSVで保存
                            </button>
                            <p class="text-xs text-slate-500 mt-2">Motive互換形式でダウンロードされます</p>
                        </div>
                    </section>
                </div>
            </div>

            <!-- Existing Data Analysis Page -->
            <div class="page" id="data-analysis">
                <div class="max-w-7xl mx-auto space-y-8">
                    <header class="text-center">
                        <h1 class="text-3xl font-bold text-slate-800">データ解析ツール</h1>
                        <p class="text-slate-500 mt-2">CSVファイルをアップロードして、剛体の運動を解析します。</p>
                    </header>
                    <section class="bg-white p-6 rounded-lg shadow-sm border">
                        <h2 class="text-xl font-semibold text-center mb-6">1. データ入力</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                            <div>
                                <label for="csv-files" class="block text-sm font-medium text-slate-700 mb-2">① CSVファイルを追加</label>
                                <div class="flex items-center space-x-2">
                                    <input type="file" id="csv-files" multiple accept=".csv" class="hidden">
                                    <label for="csv-files" class="w-full cursor-pointer bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-md text-sm text-center">ファイルを追加</label>
                                    <button id="clear-files-btn" class="flex-shrink-0 bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-2 px-3 rounded-md text-xs shadow-sm">クリア</button>
                                </div>
                                <div id="file-list" class="mt-4 space-y-2"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">② 元データの単位</label>
                                <div class="flex items-center space-x-4 mt-2">
                                    <label class="flex items-center"><input type="radio" name="data-unit" value="mm" class="form-radio" checked><span class="ml-2 text-sm">mm</span></label>
                                    <label class="flex items-center"><input type="radio" name="data-unit" value="m" class="form-radio"><span class="ml-2 text-sm">m</span></label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">③④ 方向の定義</label>
                                <div class="flex space-x-4">
                                    <div class="flex-1"><label for="travel-axis" class="block text-xs font-medium text-slate-500">進行方向</label><select id="travel-axis" class="mt-1 w-full bg-white border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 text-sm"><option value="X">X</option><option value="Y">Y</option><option value="Z" selected>Z</option></select></div>
                                    <div class="flex-1"><label for="vertical-axis" class="block text-xs font-medium text-slate-500">鉛直方向</label><select id="vertical-axis" class="mt-1 w-full bg-white border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 text-sm"><option value="X">X</option><option value="Y" selected>Y</option><option value="Z">Z</option></select></div>
                                </div>
                            </div>
                            <div class="md:col-span-2">
                                 <details class="bg-slate-50/70 border rounded-md p-4"><summary class="font-medium text-slate-700 text-sm">動作検出の高度な設定</summary><div class="mt-4 pt-4 border-t"><label for="motion-threshold-multiplier" class="block text-sm font-medium text-slate-600">静止範囲の倍率</label><input type="number" id="motion-threshold-multiplier" value="0.001" step="0.001" class="mt-1 block w-full rounded-md shadow-sm p-2 text-sm border-slate-300 focus:ring-1 focus:ring-blue-500 focus:border-blue-500"></div></details>
                            </div>
                        </div>
                    </section>
                    <section id="rigidbody-selection-section" class="bg-white p-6 rounded-lg shadow-sm border hidden">
                        <h2 class="text-xl font-semibold text-center mb-6">2. 解析対象の剛体を選択</h2>
                        <div id="rigidbody-list" class="space-y-4"></div>
                        <div class="mt-6 text-center"><button id="start-analysis-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-8 rounded-md shadow-sm transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">解析開始</button></div>
                    </section>
                    <div id="results-section" class="hidden space-y-8">
                         <section class="bg-white p-6 rounded-lg shadow-sm border">
                            <h2 class="text-xl font-semibold text-center mb-6">3. 解析結果</h2>
                            <div id="avg-velo-filter-section" class="mb-6 p-4 bg-slate-50/70 rounded-md border">
                                <h4 class="font-medium text-slate-700 mb-3 text-sm">平均速度の計算設定</h4>
                                <div class="flex items-center space-x-3"><input type="checkbox" id="filter-velocity-checkbox" class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500"><label for="filter-velocity-checkbox" class="text-sm font-medium text-slate-700">微小な速度を計算から除外する</label></div>
                                <div id="filter-range-inputs" class="hidden mt-3 flex items-center space-x-4 pl-7">
                                    <div><label for="filter-lower-bound" class="block text-xs font-medium text-slate-600">下限値 (m/s)</label><input type="number" id="filter-lower-bound" value="-0.01" step="0.01" class="mt-1 block w-32 rounded-md shadow-sm p-1.5 text-sm border-slate-300"></div>
                                    <div><label for="filter-upper-bound" class="block text-xs font-medium text-slate-600">上限値 (m/s)</label><input type="number" id="filter-upper-bound" value="0.01" step="0.01" class="mt-1 block w-32 rounded-md shadow-sm p-1.5 text-sm border-slate-300"></div>
                                    <div class="pt-5"><button id="recalculate-avg-btn" class="bg-slate-600 hover:bg-slate-700 text-white font-semibold py-1 px-3 rounded-md text-xs shadow-sm">再計算</button></div>
                                </div>
                            </div>
                            <div id="average-velocities" class="mb-6"></div>
                            <button id="download-velocity-csv" class="bg-slate-600 hover:bg-slate-700 text-white font-semibold py-2 px-4 rounded-md shadow-sm text-sm">微小速度データをCSVでダウンロード</button>
                        </section>
                        <section class="bg-white p-6 rounded-lg shadow-sm border">
                            <div class="flex flex-wrap justify-between items-center mb-6 text-center border-b pb-4"><h2 class="text-xl font-semibold w-full sm:w-auto text-center sm:text-left">4. グラフ</h2><div class="flex items-center space-x-2 mt-4 sm:mt-0 mx-auto sm:mx-0"><span class="text-sm text-slate-600">スタイル:</span><button id="style-casual" class="style-btn bg-blue-600 text-white px-3 py-1 rounded-l-md text-sm font-medium">カジュアル</button><button id="style-formal" class="style-btn bg-slate-200 text-slate-700 px-3 py-1 rounded-r-md text-sm font-medium">フォーマル</button></div></div>
                            <div id="graph-customization" class="mt-6">
                                 <div class="mb-8 p-4 bg-slate-50/70 rounded-md border"><h4 class="font-medium text-slate-700 mb-3 text-sm">グラフ描画設定</h4><div class="flex items-center flex-wrap gap-x-6 gap-y-3"><div class="flex items-center space-x-2"><label for="lowpass-filter-type" class="text-sm font-medium text-slate-700">ローパスフィルタ:</label><select id="lowpass-filter-type" class="block w-36 rounded-md shadow-sm p-1.5 text-sm border-slate-300 focus:ring-1 focus:ring-blue-500 focus:border-blue-500"><option value="none" selected>適用しない</option><option value="moving-average">移動平均</option><option value="gaussian">ガウシアン</option></select></div><div class="flex items-center space-x-2"><label id="lowpass-strength-label" for="lowpass-strength" class="text-sm font-medium text-slate-700">強度:</label><input type="number" id="lowpass-strength" value="10" step="0.1" class="block w-20 rounded-md shadow-sm p-1.5 text-sm border-slate-300 focus:ring-1 focus:ring-blue-500 focus:border-blue-500" disabled></div><button id="redraw-charts-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md shadow-sm transition-all duration-150">再描画</button></div><p id="filter-description" class="text-xs text-slate-500 mt-2">フィルタを選択すると、強度を指定できます。</p></div>
                                 <div class="mb-8 p-4 bg-slate-50/70 rounded-md border"><h4 class="font-medium text-slate-700 mb-3 text-sm">エクスポート設定</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="export-width" class="block text-sm font-medium text-slate-600">画像の幅 (px)</label><input type="number" id="export-width" value="800" step="100" class="mt-1 block w-full rounded-md shadow-sm p-2 text-sm border-slate-300"></div><div><label for="export-height" class="block text-sm font-medium text-slate-600">画像の高さ (px)</label><input type="number" id="export-height" value="450" step="100" class="mt-1 block w-full rounded-md shadow-sm p-2 text-sm border-slate-300"></div></div></div>
                                <h3 class="text-lg font-semibold mb-4 text-slate-700">グラフのラベル編集</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                                    <div class="space-y-2 p-3 border rounded-md bg-slate-50/50"><h4 class="font-semibold text-center text-slate-700 text-sm">速度 vs 距離</h4><div><label class="text-xs font-medium text-slate-600">タイトル</label><input type="text" id="v-chart-title" data-chart-id="velocity-chart" data-label-type="title" class="chart-label-input mt-1 w-full rounded-md p-1.5 text-sm border-slate-300"></div><div><label class="text-xs font-medium text-slate-600">X軸</label><input type="text" id="v-chart-xlabel" data-chart-id="velocity-chart" data-label-type="x" class="chart-label-input mt-1 w-full rounded-md p-1.5 text-sm border-slate-300"></div><div><label class="text-xs font-medium text-slate-600">Y軸</label><input type="text" id="v-chart-ylabel" data-chart-id="velocity-chart" data-label-type="y" class="chart-label-input mt-1 w-full rounded-md p-1.5 text-sm border-slate-300"></div></div>
                                    <div class="space-y-2 p-3 border rounded-md bg-slate-50/50"><h4 class="font-semibold text-center text-slate-700 text-sm">スリップ率 vs 距離</h4><div><label class="text-xs font-medium text-slate-600">タイトル</label><input type="text" id="s-chart-title" data-chart-id="slip-chart" data-label-type="title" class="chart-label-input mt-1 w-full rounded-md p-1.5 text-sm border-slate-300"></div><div><label class="text-xs font-medium text-slate-600">X軸</label><input type="text" id="s-chart-xlabel" data-chart-id="slip-chart" data-label-type="x" class="chart-label-input mt-1 w-full rounded-md p-1.5 text-sm border-slate-300"></div><div><label class="text-xs font-medium text-slate-600">Y軸</label><input type="text" id="s-chart-ylabel" data-chart-id="slip-chart" data-label-type="y" class="chart-label-input mt-1 w-full rounded-md p-1.5 text-sm border-slate-300"></div></div>
                                    <div class="space-y-2 p-3 border rounded-md bg-slate-50/50"><h4 class="font-semibold text-center text-slate-700 text-sm">鉛直変位 vs 距離</h4><div><label class="text-xs font-medium text-slate-600">タイトル</label><input type="text" id="z-chart-title" data-chart-id="vertical-chart" data-label-type="title" class="chart-label-input mt-1 w-full rounded-md p-1.5 text-sm border-slate-300"></div><div><label class="text-xs font-medium text-slate-600">X軸</label><input type="text" id="z-chart-xlabel" data-chart-id="vertical-chart" data-label-type="x" class="chart-label-input mt-1 w-full rounded-md p-1.5 text-sm border-slate-300"></div><div><label class="text-xs font-medium text-slate-600">Y軸</label><input type="text" id="z-chart-ylabel" data-chart-id="vertical-chart" data-label-type="y" class="chart-label-input mt-1 w-full rounded-md p-1.5 text-sm border-slate-300"></div></div>
                                    <div class="space-y-2 p-3 border rounded-md bg-slate-50/50"><h4 class="font-semibold text-center text-slate-700 text-sm">平面移動軌跡</h4><div><label class="text-xs font-medium text-slate-600">タイトル</label><input type="text" id="t-chart-title" data-chart-id="trajectory-chart" data-label-type="title" class="chart-label-input mt-1 w-full rounded-md p-1.5 text-sm border-slate-300"></div><div><label class="text-xs font-medium text-slate-600">X軸</label><input type="text" id="t-chart-xlabel" data-chart-id="trajectory-chart" data-label-type="x" class="chart-label-input mt-1 w-full rounded-md p-1.5 text-sm border-slate-300"></div><div><label class="text-xs font-medium text-slate-600">Y軸</label><input type="text" id="t-chart-ylabel" data-chart-id="trajectory-chart" data-label-type="y" class="chart-label-input mt-1 w-full rounded-md p-1.5 text-sm border-slate-300"></div></div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-8 gap-y-12 mt-8">
                                <div><div class="w-full aspect-video bg-white p-2 border rounded-lg shadow-sm"><div class="chart-container"><canvas id="velocity-chart"></canvas></div></div><div class="text-center mt-3 flex justify-center items-center space-x-2"><button class="zoom-btn bg-slate-200 hover:bg-slate-300 text-slate-600 h-8 w-8 flex items-center justify-center rounded-md transition-colors" data-chart-id="velocity-chart" title="拡大表示"><svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" /></svg></button><button class="download-btn bg-slate-600 hover:bg-slate-700 text-white text-xs h-8 px-3 flex items-center justify-center rounded-md" data-chart-id="velocity-chart" data-format="png">PNG</button><button class="download-btn bg-slate-600 hover:bg-slate-700 text-white text-xs h-8 px-3 flex items-center justify-center rounded-md" data-chart-id="velocity-chart" data-format="pdf">PDF</button></div></div>
                                <div><div class="w-full aspect-video bg-white p-2 border rounded-lg shadow-sm"><div class="chart-container"><canvas id="slip-chart"></canvas></div></div><div class="text-center mt-3 flex justify-center items-center space-x-2"><button class="zoom-btn bg-slate-200 hover:bg-slate-300 text-slate-600 h-8 w-8 flex items-center justify-center rounded-md transition-colors" data-chart-id="slip-chart" title="拡大表示"><svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" /></svg></button><button class="download-btn bg-slate-600 hover:bg-slate-700 text-white text-xs h-8 px-3 flex items-center justify-center rounded-md" data-chart-id="slip-chart" data-format="png">PNG</button><button class="download-btn bg-slate-600 hover:bg-slate-700 text-white text-xs h-8 px-3 flex items-center justify-center rounded-md" data-chart-id="slip-chart" data-format="pdf">PDF</button></div></div>
                                <div><div class="w-full aspect-video bg-white p-2 border rounded-lg shadow-sm"><div class="chart-container"><canvas id="vertical-chart"></canvas></div></div><div class="text-center mt-3 flex justify-center items-center space-x-2"><button class="zoom-btn bg-slate-200 hover:bg-slate-300 text-slate-600 h-8 w-8 flex items-center justify-center rounded-md transition-colors" data-chart-id="vertical-chart" title="拡大表示"><svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" /></svg></button><button class="download-btn bg-slate-600 hover:bg-slate-700 text-white text-xs h-8 px-3 flex items-center justify-center rounded-md" data-chart-id="vertical-chart" data-format="png">PNG</button><button class="download-btn bg-slate-600 hover:bg-slate-700 text-white text-xs h-8 px-3 flex items-center justify-center rounded-md" data-chart-id="vertical-chart" data-format="pdf">PDF</button></div></div>
                                <div><div class="w-full aspect-video bg-white p-2 border rounded-lg shadow-sm"><div class="chart-container"><canvas id="trajectory-chart"></canvas></div></div><div class="text-center mt-3 flex justify-center items-center space-x-2"><button class="zoom-btn bg-slate-200 hover:bg-slate-300 text-slate-600 h-8 w-8 flex items-center justify-center rounded-md transition-colors" data-chart-id="trajectory-chart" title="拡大表示"><svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" /></svg></button><button class="download-btn bg-slate-600 hover:bg-slate-700 text-white text-xs h-8 px-3 flex items-center justify-center rounded-md" data-chart-id="trajectory-chart" data-format="png">PNG</button><button class="download-btn bg-slate-600 hover:bg-slate-700 text-white text-xs h-8 px-3 flex items-center justify-center rounded-md" data-chart-id="trajectory-chart" data-format="pdf">PDF</button></div></div>
                            </div>
                        </section>
                    </div>
                </div>
            </div>

            <!-- Wide Area Analysis Page -->
            <div class="page" id="wide-area-analysis">
                <div class="max-w-7xl mx-auto space-y-8">
                    <header class="text-center">
                        <h1 class="text-3xl font-bold text-slate-800">広域解析ツール</h1>
                        <p class="text-slate-500 mt-2">CSVファイルをアップロードして、広範囲の移動軌跡や滞在傾向を可視化します。</p>
                    </header>
                     <section id="settings-card-wide" class="bg-white p-6 rounded-lg shadow-sm border">
                        <h2 class="text-xl font-semibold text-center mb-6">1. 設定</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div><label for="csv-files-wide" class="block text-sm font-medium text-slate-700 mb-2">① CSVファイルを追加</label><div class="flex items-center space-x-2"><input type="file" id="csv-files-wide" multiple accept=".csv" class="hidden"><label for="csv-files-wide" class="w-full cursor-pointer bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-md text-sm text-center">ファイルを追加</label><button id="clear-files-btn-wide" class="flex-shrink-0 bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-2 px-3 rounded-md text-xs shadow-sm">クリア</button></div><div id="file-list-area-wide" class="mt-4 space-y-2"></div></div>
                             <div class="space-y-4">
                                 <div><label class="block text-sm font-medium text-slate-700 mb-2">② 元データの単位</label><div class="flex items-center space-x-4 mt-2"><label class="flex items-center"><input type="radio" name="data-unit-wide" value="mm" class="form-radio" checked> <span class="ml-2 text-sm">mm</span></label><label class="flex items-center"><input type="radio" name="data-unit-wide" value="m" class="form-radio"> <span class="ml-2 text-sm">m</span></label></div></div>
                                <div><label for="sampling-rate-wide" class="block text-sm font-medium text-slate-700 mb-2">③ データ取得間隔 (秒)</label><input type="number" id="sampling-rate-wide" value="1.0" step="0.1" min="0.01" class="block w-full rounded-md shadow-sm p-2 text-sm border-slate-300 focus:ring-1 focus:ring-blue-500 focus:border-blue-500"></div>
                                 <div><label for="heatmap-grid-size-wide" class="block text-sm font-medium text-slate-700 mb-2">④ ヒートマップのマス目のサイズ (<span class="unit-label">mm</span>)</label><input type="number" id="heatmap-grid-size-wide" value="500" step="100" class="block w-full rounded-md shadow-sm p-2 text-sm border-slate-300 focus:ring-1 focus:ring-blue-500 focus:border-blue-500"></div>
                                 <div><label class="block text-sm font-medium text-slate-700 mb-2">⑤ 方向の定義</label><div class="flex space-x-4"><div class="flex-1"><label for="vertical-axis-wide" class="block text-xs font-medium text-slate-500">鉛直方向の軸</label><select id="vertical-axis-wide" class="mt-1 w-full bg-white border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 text-sm"><option value="X">X</option><option value="Y" selected>Y</option><option value="Z">Z</option></select></div></div></div>
                            </div>
                        </div>
                        <div id="rigidbody-selection-area-wide" class="mt-6 hidden"><label class="block text-sm font-medium text-slate-700 mb-2">⑤ 解析対象の剛体を選択</label><div id="rigidbody-list-container-wide" class="space-y-4 p-4 border rounded-md bg-slate-50/70 max-h-60 overflow-y-auto"></div></div>
                        <div class="text-center mt-8"><button id="analyze-btn-wide" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 px-8 rounded-md shadow-sm transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-slate-400 disabled:cursor-not-allowed disabled:transform-none" disabled>解析開始</button></div>
                    </section>
                    <section id="results-card-wide" class="bg-white p-6 rounded-lg shadow-sm border hidden">
                        <h2 class="text-xl font-semibold text-center mb-4">2. 解析結果</h2>
                        <div class="flex justify-center mb-6 border-b"><button id="show-trajectory-btn-wide" class="tab-btn active font-medium py-2 px-6 rounded-t-md transition-colors">軌跡</button><button id="show-heatmap-btn-wide" class="tab-btn font-medium py-2 px-6 rounded-t-md transition-colors">ヒートマップ</button><button id="show-3d-trajectory-btn-wide" class="tab-btn font-medium py-2 px-6 rounded-t-md transition-colors">3D軌跡</button></div>
                        <div id="trajectory-view-wide"><div class="w-full max-w-2xl mx-auto"><div class="flex justify-end items-center mb-2"><label for="height-info-checkbox-wide" class="flex items-center cursor-pointer"><input type="checkbox" id="height-info-checkbox-wide" class="form-checkbox h-4 w-4 text-blue-600 rounded border-slate-300 focus:ring-blue-500"><span class="ml-2 text-sm text-slate-700">高さ情報を含む</span></label></div><div class="aspect-square bg-white p-2 relative border rounded-lg shadow-sm"><div class="chart-container"><canvas id="trajectory-chart-wide"></canvas><div id="height-legend-wide" class="hidden absolute top-2 right-2 bg-white/80 backdrop-blur-sm p-2 rounded-md border text-xs"><div class="font-semibold text-center text-slate-700 mb-1">高さ (m)</div><div class="flex items-center space-x-2"><span id="height-legend-min-wide">0.0</span><div id="height-legend-gradient-wide" class="w-20 h-3 rounded-sm border"></div><span id="height-legend-max-wide">0.0</span></div></div></div></div></div><div class="text-center mt-4 flex justify-center items-center space-x-2"><button class="download-btn-wide bg-slate-600 hover:bg-slate-700 text-white text-sm h-9 px-4 flex items-center justify-center rounded-md" data-target="trajectory-chart-wide" data-format="png">PNGで保存</button><button class="download-btn-wide bg-slate-600 hover:bg-slate-700 text-white text-sm h-9 px-4 flex items-center justify-center rounded-md" data-target="trajectory-chart-wide" data-format="pdf">PDFで保存</button></div></div>
                        <div id="heatmap-view-wide" class="hidden"><div id="heatmap-container-wide" class="w-full max-w-2xl mx-auto aspect-square relative bg-slate-50 border rounded-lg shadow-sm"><canvas id="heatmap-canvas-wide"></canvas><div id="heatmap-tooltip" class="hidden absolute bg-black/70 text-white text-xs rounded-md px-2 py-1 pointer-events-none shadow-lg"></div></div><div id="heatmap-legend-wide" class="flex justify-end items-center mt-2 max-w-2xl mx-auto space-x-2 text-sm"><span>Min</span><div class="w-32 h-4 rounded-md" style="background: linear-gradient(to right, rgb(0, 0, 255), rgb(0, 255, 255), rgb(0, 255, 0), rgb(255, 255, 0), rgb(255, 0, 0));"></div><span>Max (<span id="heatmap-max-value-wide">0</span>)</span></div><div class="text-center mt-4 flex justify-center items-center space-x-2"><button class="download-btn-wide bg-slate-600 hover:bg-slate-700 text-white text-sm h-9 px-4 flex items-center justify-center rounded-md" data-target="heatmap-canvas-wide" data-format="png">PNGで保存</button><button class="download-btn-wide bg-slate-600 hover:bg-slate-700 text-white text-sm h-9 px-4 flex items-center justify-center rounded-md" data-target="heatmap-canvas-wide" data-format="pdf">PDFで保存</button></div></div>
                        <div id="trajectory-3d-view-wide" class="hidden"><div id="trajectory-3d-container-wide" class="w-full max-w-2xl mx-auto aspect-square relative bg-slate-50 border rounded-lg shadow-sm"></div></div>
                        <p id="coordinate-unit-note" class="text-xs text-slate-500 mt-4 text-center">※ 座標は正規化せず、元データの値をメートル単位に変換して使用しています。</p>
                        <div id="coverage-section-wide" class="mt-8 pt-6 border-t"><h3 class="text-lg font-semibold text-center mb-4 text-slate-800">網羅率の計算</h3><div class="max-w-2xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6 p-4 bg-slate-50 border rounded-lg"><div class="space-y-4"><div><label class="block text-sm font-medium text-slate-700">基準範囲の形状</label><div class="mt-2 flex gap-4"><label class="flex items-center"><input type="radio" name="area-shape-wide" value="circle" class="form-radio" checked> <span class="ml-2">円</span></label><label class="flex items-center"><input type="radio" name="area-shape-wide" value="square" class="form-radio"> <span class="ml-2">正方形</span></label></div></div><div><label for="area-size-wide" class="block text-sm font-medium text-slate-700"><span id="area-size-label-wide">半径</span> (<span class="unit-label">mm</span>)</label><input type="number" id="area-size-wide" value="2000" step="100" class="mt-1 block w-full rounded-md shadow-sm p-2 text-sm border-slate-300"></div><div><label class="block text-sm font-medium text-slate-700">中心座標</label><div class="mt-2 flex gap-4"><label class="flex items-center"><input type="radio" name="center-type-wide" value="data" class="form-radio" checked> <span class="ml-2">データの中心</span></label><label class="flex items-center"><input type="radio" name="center-type-wide" value="custom" class="form-radio"> <span class="ml-2">座標指定</span></label></div></div><div id="custom-center-inputs-wide" class="hidden space-y-2"><div class="flex items-center gap-2"><label for="center-x-wide" class="text-sm" id="center-x-label-wide">X:</label><input type="number" id="center-x-wide" value="0" step="0.1" class="block w-full rounded-md shadow-sm p-2 text-sm border-slate-300"><label for="center-y-wide" class="text-sm" id="center-y-label-wide">Y:</label><input type="number" id="center-y-wide" value="0" step="0.1" class="block w-full rounded-md shadow-sm p-2 text-sm border-slate-300"></div></div></div><div class="flex flex-col items-center justify-center bg-white p-4 rounded-md border"><button id="calculate-coverage-btn-wide" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2.5 px-6 rounded-md shadow-sm">計算実行</button><div class="mt-4 text-center"><p class="text-sm text-slate-600">網羅率</p><p class="text-3xl font-bold text-slate-800 my-1"><span id="coverage-result-wide">--</span> %</p></div></div></div></div>
                    </section>
                </div>
            </div>

            <!-- Standard Velocity Tool -->
            <div class="page" id="standard-velocity">
                <div class="max-w-3xl mx-auto space-y-8">
                    <header class="text-center">
                        <h1 class="text-3xl font-bold text-slate-800">基準速度算出ツール</h1>
                        <p class="text-slate-500 mt-2">モーションキャプチャのCSVデータから車輪の基準速度を計算します。</p>
                    </header>
                    <section id="step-1-file-upload-std" class="bg-white p-6 rounded-lg shadow-sm border"><h2 class="text-xl font-semibold text-center mb-6">1. データ入力</h2><div class="mt-4 flex flex-col items-center gap-3"><label for="csv-file-input-std" class="cursor-pointer bg-slate-100 hover:bg-slate-200 text-slate-800 font-semibold py-2 px-5 border border-slate-300 rounded-md shadow-sm transition-colors">ファイルを選択</label><input type="file" id="csv-file-input-std" class="hidden" accept=".csv"><p id="file-name-display-std" class="text-sm text-slate-500 mt-2">ファイルが選択されていません</p></div></section>
                     <div id="loading-indicator-std" class="hidden flex-col items-center justify-center py-10"><div class="loader"></div><p class="text-slate-600 mt-4">ファイルを解析中...</p></div>
                    <section id="step-2-parameters-std" class="hidden bg-white p-6 rounded-lg shadow-sm border"><h2 class="text-xl font-semibold text-center mb-6">2. パラメータ設定</h2><div class="mt-4 space-y-5 max-w-sm mx-auto"><div><label class="block text-sm font-medium text-slate-700">② 車輪の剛体を選択</label><div id="rigidbody-radio-container-std" class="mt-2 space-y-2 max-h-40 overflow-y-auto border p-3 rounded-md bg-slate-50/70"></div></div><div><label for="radius-input-std" class="block text-sm font-medium text-slate-700">③ 車輪の半径 (cm)</label><input type="number" id="radius-input-std" value="10" step="1" class="mt-1 block w-full border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm"></div><div><label for="axis-select-std" class="block text-sm font-medium text-slate-700">④ 車輪の回転軸</label><select id="axis-select-std" class="mt-1 block w-full bg-white border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm"><option value="X">X軸</option><option value="Y" selected>Y軸</option><option value="Z">Z軸</option></select></div></div><div class="text-center mt-8"><button id="calculate-btn-std" class="w-full max-w-sm bg-green-600 hover:bg-green-700 text-white font-semibold py-2.5 px-6 rounded-md shadow-sm transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">計算開始</button></div></section>
                    <section id="step-3-results-std" class="hidden bg-white p-6 rounded-lg shadow-sm border"><h2 class="text-xl font-semibold text-center mb-6">3. 計算結果</h2><div id="result-display-std" class="hidden mt-6 p-6 bg-slate-50/70 rounded-lg text-center border"><p class="text-sm text-slate-600">算出された基準速度 (v)</p><p class="text-4xl font-bold text-slate-800 my-2 tracking-tight"><span id="result-value-std">0.00000000</span> m/s</p><button id="copy-btn-std" class="mt-4 bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-1.5 px-4 rounded-md text-sm transition-colors" data-copy-value="">結果をコピー</button></div><div id="error-display-std" class="hidden mt-6 p-4 bg-red-50 text-red-800 border-l-4 border-red-400 rounded-md"></div></section>
                </div>
            </div>

            <!-- How To Use Page -->
            <div class="page" id="how-to-use">
                 <h1 class="text-2xl font-semibold text-gray-800 mb-8 text-center">使い方ガイド</h1>
                 <div class="space-y-10">
                    <div class="bg-white/70 backdrop-blur-xl rounded-xl border border-gray-200/80 shadow-sm">
                        <div class="p-6 sm:p-8">
                            <h2 class="text-xl font-semibold text-gray-900 flex items-center gap-3 mb-6">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="text-gray-500"><path stroke-linecap="round" stroke-linejoin="round" d="M14.121 14.121L19 19m-7-7l7-7m-7 7l-2.879 2.879M12 12L9.121 9.121m0 5.758a3 3 0 10-4.243 4.243 3 3 0 004.243-4.243zm0-5.758a3 3 0 10-4.243-4.243 3 3 0 004.243 4.243z" /></svg>
                                <span>データトリミングツール</span>
                            </h2>
                            <div class="space-y-6">
                                <div class="flex items-start gap-4">
                                    <div class="flex-shrink-0 bg-gray-200 text-gray-600 rounded-full h-7 w-7 text-sm flex items-center justify-center font-medium mt-1">1</div>
                                    <div><h3 class="text-base font-medium text-gray-800 mb-3">ファイルの選択</h3><p class="text-gray-600 text-sm">MotiveからエクスポートしたCSVファイルを選択します。</p></div>
                                </div>
                                <div class="flex items-start gap-4">
                                    <div class="flex-shrink-0 bg-gray-200 text-gray-600 rounded-full h-7 w-7 text-sm flex items-center justify-center font-medium mt-1">2</div>
                                    <div><h3 class="text-base font-medium text-gray-800 mb-3">範囲の指定</h3><p class="text-gray-600 text-sm">グラフ下のスライダーをドラッグするか、開始・終了時間を直接入力して、切り出したい区間を指定します。</p></div>
                                </div>
                                <div class="flex items-start gap-4">
                                    <div class="flex-shrink-0 bg-gray-200 text-gray-600 rounded-full h-7 w-7 text-sm flex items-center justify-center font-medium mt-1">3</div>
                                    <div><h3 class="text-base font-medium text-gray-800 mb-3">保存</h3><p class="text-gray-600 text-sm">「トリミングしたデータをCSVで保存」ボタンを押すと、指定範囲のデータがMotiveと同じ形式でダウンロードされます。</p></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- ... (Other sections kept) ... -->
                 </div>
            </div>

            <!-- Other pages -->
            <div class="page" id="algorithms"><div class="max-w-4xl mx-auto space-y-8"><div class="bg-white p-8 rounded-lg shadow-sm border"><h1 class="text-2xl font-bold text-slate-800 mb-6 border-b pb-3">アルゴリズム仕様</h1><div class="prose-styles"><p>本ツールで採用されているデータ解析のアルゴリズムおよび計算式について、その詳細を以下に示します。</p><!-- ... (Content same as original) ... --></div></div></div></div>
            <div class="page" id="about"><div class="max-w-4xl mx-auto space-y-8"><div class="bg-white p-8 rounded-lg shadow-sm border"><h1 class="text-2xl font-bold text-slate-800 mb-6 border-b pb-3">このツールについて</h1><div class="prose prose-slate max-w-none"><div><h2 class="text-xl font-semibold text-slate-700">基本情報</h2><div class="mt-3 grid grid-cols-1 gap-y-2 text-sm"><p><span class="w-24 inline-block font-medium text-slate-500">アプリ名:</span> Mocap Plus</p><p><span class="w-24 inline-block font-medium text-slate-500">バージョン:</span> 3.1.0 (トリミング機能追加)</p><p><span class="w-24 inline-block font-medium text-slate-500">製作者:</span> 中央大学理工学部 國井研究室 西藤 実</p></div></div><!-- ... --></div></div></div></div>
        </main>
    </div>
</div>

<!-- Modals -->
<div id="mobile-menu-overlay" class="lg:hidden fixed inset-0 z-40 hidden opacity-0"><div class="absolute inset-0 bg-black/40 backdrop-blur-sm"></div><div id="mobile-menu-content" class="relative bg-slate-100 w-64 h-full shadow-lg p-4 transform -translate-x-full"><button id="mobile-menu-close-btn" class="absolute top-4 right-4 p-2"><svg class="h-6 w-6 text-slate-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button><div class="flex items-center mb-6"><img src="icons/icon-192.png" style="width: 25px; height: auto;"><h1 class="text-lg font-bold text-slate-800 ml-2">Mocap Plus</h1></div><nav class="space-y-2" id="mobile-nav-links"><a class="nav-link block px-4 py-2 text-slate-700 hover:bg-slate-200 rounded-md" href="#home">ホーム</a><a class="nav-link block px-4 py-2 text-slate-700 hover:bg-slate-200 rounded-md" href="#data-analysis">データ解析ツール</a><a class="nav-link block px-4 py-2 text-slate-700 hover:bg-slate-200 rounded-md" href="#trimming-tool">トリミングツール</a><a class="nav-link block px-4 py-2 text-slate-700 hover:bg-slate-200 rounded-md" href="#wide-area-analysis">広域解析ツール</a><a class="nav-link block px-4 py-2 text-slate-700 hover:bg-slate-200 rounded-md" href="#standard-velocity">基準速度算出ツール</a><a class="nav-link block px-4 py-2 text-slate-700 hover:bg-slate-200 rounded-md" href="#how-to-use">使い方ガイド</a><a class="nav-link block px-4 py-2 text-slate-700 hover:bg-slate-200 rounded-md" href="#algorithms">アルゴリズム仕様</a><a class="nav-link block px-4 py-2 text-slate-700 hover:bg-slate-200 rounded-md" href="#about">このツールについて</a></nav></div></div>
<div id="chart-zoom-modal" class="hidden fixed top-0 left-0 w-full h-full bg-black/60 backdrop-blur-sm flex justify-center items-center z-50 p-4 transition-opacity duration-300"><div class="bg-white rounded-lg shadow-xl w-full max-w-5xl h-full max-h-[90vh] flex flex-col"><div class="flex justify-end p-2"><button id="modal-close-btn" class="p-2 text-slate-500 hover:text-slate-800 rounded-full hover:bg-slate-100 transition-colors"><svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button></div><div class="flex-1 min-h-0 p-4 pt-0"><canvas id="modal-chart-canvas"></canvas></div></div></div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Global Variables ---
        let modalChartInstance = null;

        // --- SPA Navigation ---
        const pages = document.querySelectorAll('.page');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
        const mobileMenuContent = document.getElementById('mobile-menu-content');
        const mobileMenuCloseBtn = document.getElementById('mobile-menu-close-btn');
        const mobileTitle = document.getElementById('mobile-title');

        function openMobileMenu() { if (!mobileMenuOverlay) return; document.body.classList.add('mobile-menu-open'); mobileMenuOverlay.classList.remove('hidden'); setTimeout(() => { mobileMenuOverlay.classList.remove('opacity-0'); if(mobileMenuContent) mobileMenuContent.classList.remove('-translate-x-full'); }, 10); }
        function closeMobileMenu() { if (!mobileMenuOverlay) return; document.body.classList.remove('mobile-menu-open'); mobileMenuOverlay.classList.add('opacity-0'); if(mobileMenuContent) mobileMenuContent.classList.add('-translate-x-full'); setTimeout(() => { mobileMenuOverlay.classList.add('hidden'); }, 300); }
        if (mobileMenuBtn) mobileMenuBtn.addEventListener('click', openMobileMenu);
        if (mobileMenuCloseBtn) mobileMenuCloseBtn.addEventListener('click', closeMobileMenu);
        if (mobileMenuOverlay) mobileMenuOverlay.addEventListener('click', (e) => { if (e.target === mobileMenuOverlay) closeMobileMenu(); });

         const allNavLinks = document.querySelectorAll('.nav-link, .nav-card');
         allNavLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageId = link.getAttribute('href').substring(1);
                history.pushState(null, '', '#' + pageId);
                showPage(pageId);
                closeMobileMenu();
            });
        });

        function showPage(pageId) {
            pages.forEach(page => page.classList.remove('active'));
            const targetPage = document.getElementById(pageId);
            if(targetPage) targetPage.classList.add('active');
            document.querySelectorAll('.nav-link').forEach(link => {
                const linkPageId = link.getAttribute('href').substring(1);
                const isActive = linkPageId === pageId;
                link.classList.toggle('active', isActive);
                if(isActive && mobileTitle) mobileTitle.textContent = link.querySelector('span')?.textContent || link.textContent.trim();
            });
            window.scrollTo(0, 0);
        }

        window.addEventListener('popstate', () => { showPage(window.location.hash ? window.location.hash.substring(1) : 'home'); });
        const initialPage = window.location.hash ? window.location.hash.substring(1) : 'home';
        showPage(document.getElementById(initialPage) ? initialPage : 'home');

        // --- TRIMMING TOOL LOGIC ---
        const trimFileInput = document.getElementById('csv-file-trimming');
        const trimEditorSection = document.getElementById('trimming-editor-section');
        const trimBodySelect = document.getElementById('trimming-body-select');
        const trimTargetPointsInput = document.getElementById('trim-target-points');
        const trimMainChartCanvas = document.getElementById('trimming-main-chart');
        const trimTimelineCanvas = document.getElementById('timeline-canvas');
        const trimStartTimeInput = document.getElementById('trim-start-time');
        const trimEndTimeInput = document.getElementById('trim-end-time');
        const exportTrimmedBtn = document.getElementById('export-trimmed-csv-btn');
        const timelineSlider = document.getElementById('timeline-slider');
        const rangeOverlay = document.getElementById('range-overlay');
        const unselectedLeft = document.getElementById('unselected-left');
        const unselectedRight = document.getElementById('unselected-right');
        const trimDataUnitRadios = document.querySelectorAll('input[name="trim-data-unit"]'); // NEW

        let trimRawData = null; // Full raw CSV text lines
        let trimHeaderLines = []; // Metadata lines
        let trimParsedData = []; // Array of objects
        let trimRigidBodies = {};
        let trimMainChart = null;
        let trimCurrentBody = null;
        let trimTotalDuration = 0;
        let trimStartTime = 0;
        let trimEndTime = 0;
        let isDraggingHandle = null; // 'left', 'right', 'move'
        let trimDownsampledData = [];

        if(trimFileInput) {
            trimFileInput.addEventListener('change', handleTrimFileSelect);
            trimBodySelect.addEventListener('change', updateTrimCharts);
            if(trimTargetPointsInput) trimTargetPointsInput.addEventListener('change', updateTrimCharts);
            trimStartTimeInput.addEventListener('change', updateRangeFromInputs);
            trimEndTimeInput.addEventListener('change', updateRangeFromInputs);
            exportTrimmedBtn.addEventListener('click', exportTrimmedData);

            // Timeline Slider Events
            timelineSlider.addEventListener('mousedown', startDragTimeline);
            window.addEventListener('mousemove', dragTimeline);
            window.addEventListener('mouseup', stopDragTimeline);

            // Add touch support
            timelineSlider.addEventListener('touchstart', (e) => startDragTimeline(e.touches[0]));
            window.addEventListener('touchmove', (e) => { if(isDraggingHandle) e.preventDefault(); dragTimeline(e.touches[0]); }, {passive: false});
            window.addEventListener('touchend', stopDragTimeline);

            // Unit selection event
            trimDataUnitRadios.forEach(radio => radio.addEventListener('change', updateTrimCharts));
        }

        function handleTrimFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // document.getElementById('loading').classList.remove('hidden');
            // document.getElementById('loading-text').textContent = 'ファイルを読み込み中...';

            // Use FileReader to get raw text for exporting later (preserves format)
            const reader = new FileReader();
            reader.onload = function(e) {
                const csvText = e.target.result;
                processTrimFile(csvText);
            };
            reader.readAsText(file);
        }

        function processTrimFile(csvText) {
            // 1. Store raw lines for export preservation
            const lines = csvText.split(/\r\n|\n/);
            trimRawData = lines;

            // 2. Parse strictly for structure analysis using Papa Parse
            const parsedResult = Papa.parse(csvText, { skipEmptyLines: false }); // Do not skip empty lines here to keep line indices consistent
            const data = parsedResult.data;

            if (!data || data.length < 10) {
                alert('データが短すぎるか、読み込めませんでした。');
                document.getElementById('loading').classList.add('hidden');
                return;
            }

            // 3. Find Header Structure
            let typeRowIndex = -1, nameRowIndex = -1, propertyRowIndex = -1, dataStartIndex = -1;
            let colOffset = 1; // Default to 1 (Type at index 1)

            // Scan first 50 rows to find metadata
            for(let i=0; i<Math.min(50, data.length); i++) {
                const row = data[i];
                if(!row || row.length < 2) continue;

                if(row[0] === 'Type') {
                    typeRowIndex = i;
                    colOffset = 0;
                } else if(row[1] === 'Type') {
                    typeRowIndex = i;
                    colOffset = 1;
                }

                if(row[colOffset] === 'Name') nameRowIndex = i;

                // Robust check: Row containing property headers
                if(row.includes('Rotation') || row.includes('Position')) propertyRowIndex = i;

                if(row[0] === 'Frame' && row[1] === 'Time (Seconds)') {
                    dataStartIndex = i + 1; // Data starts next line
                    break;
                }
            }

            if(dataStartIndex === -1 || typeRowIndex === -1 || nameRowIndex === -1 || propertyRowIndex === -1) {
                 alert('Motive CSVのヘッダー構造を正しく解析できませんでした。\n「データ解析ツール」と同じ形式のCSVを使用してください。');
                 document.getElementById('loading').classList.add('hidden');
                 return;
            }

            trimHeaderLines = lines.slice(0, dataStartIndex); // Store header lines for export

            // 4. Extract Rigid Bodies
            const typeRow = data[typeRowIndex];
            const nameRow = data[nameRowIndex];
            const propertyRow = data[propertyRowIndex]; // Use the identified property row

            trimRigidBodies = {};

            // Scan columns starting from offset + 1
            // If colOffset is 1 (Type at 1), headers are at 2, 3... -> start at 2
            // If colOffset is 0 (Type at 0), headers are at 1, 2... -> start at 1
            const scanStart = colOffset + 1;

            for (let i = scanStart; i < typeRow.length; i++) {
                if (typeRow[i] === 'Rigid Body' && propertyRow[i] === 'Position') {
                    const name = nameRow[i];
                    if (!name) continue;

                    // If we already have this body, skip (should not happen with standard format logic)
                    if (trimRigidBodies[name]) continue;

                    // Found a Position start for a Rigid Body.
                    // Typically Position X, Y, Z are consecutive.
                    // Verify the columns
                    const xCol = i;
                    const yCol = i + 1;
                    const zCol = i + 2;

                    // Simple validation: Ensure these exist
                    if (zCol < typeRow.length) {
                         trimRigidBodies[name] = {
                             name,
                             xIndex: xCol,
                             yIndex: yCol,
                             zIndex: zCol
                         };
                    }

                    // Skip the next 2 columns since we consumed them for Y and Z
                    i += 2;
                }
            }

            if (Object.keys(trimRigidBodies).length === 0) {
                alert('ファイル内に有効な剛体(Rigid Body)が見つかりませんでした。');
                document.getElementById('loading').classList.add('hidden');
                return;
            }

            // 5. Store Data for Parsing
            const rawDataRows = data.slice(dataStartIndex);
            trimParsedData = rawDataRows.map((row, idx) => {
                if (!row || row.length < 2) return null;
                const t = parseFloat(row[1]);
                if (isNaN(t)) return null;
                return { t, row, originalLineIndex: dataStartIndex + idx };
            }).filter(d => d !== null);

            if (trimParsedData.length === 0) {
                alert('データ行がありません。');
                document.getElementById('loading').classList.add('hidden');
                return;
            }

            trimStartTime = trimParsedData[0].t;
            trimEndTime = trimParsedData[trimParsedData.length - 1].t;
            trimTotalDuration = trimEndTime - trimStartTime;

            // UI Update
            trimBodySelect.innerHTML = Object.keys(trimRigidBodies).map(n => `<option value="${n}">${n}</option>`).join('');
            trimStartTimeInput.value = trimStartTime.toFixed(3);
            trimEndTimeInput.value = trimEndTime.toFixed(3);

            trimEditorSection.classList.remove('hidden');
            updateTrimCharts();

            document.getElementById('loading').classList.add('hidden');
        }

        function updateTrimCharts() {
            const bodyName = trimBodySelect.value;
            if(!bodyName || !trimRigidBodies[bodyName]) return;
            trimCurrentBody = trimRigidBodies[bodyName];

            // Downsample for charts based on user input
            const userTargetPoints = trimTargetPointsInput ? parseInt(trimTargetPointsInput.value) : 1500;
            const targetPoints = isNaN(userTargetPoints) || userTargetPoints <= 0 ? 1500 : userTargetPoints;

            // Unit Multiplier
            const unitMultiplier = document.querySelector('input[name="trim-data-unit"]:checked').value === 'mm' ? 1000 : 1;

            const step = Math.max(1, Math.ceil(trimParsedData.length / targetPoints));
            trimDownsampledData = [];

            for(let i=0; i<trimParsedData.length; i+=step) {
                const d = trimParsedData[i];
                // Using parsed row data
                const x = parseFloat(d.row[trimCurrentBody.xIndex]) * unitMultiplier;
                const y = parseFloat(d.row[trimCurrentBody.yIndex]) * unitMultiplier;
                const z = parseFloat(d.row[trimCurrentBody.zIndex]) * unitMultiplier;

                if (!isNaN(x) && !isNaN(y) && !isNaN(z)) {
                    trimDownsampledData.push({ t: d.t, x, y, z });
                }
            }

            renderTimelineCanvas();
            renderMainChart();
            updateSliderPosition();
        }

        function renderTimelineCanvas() {
            const ctx = trimTimelineCanvas.getContext('2d');
            trimTimelineCanvas.width = timelineSlider.clientWidth;
            trimTimelineCanvas.height = timelineSlider.clientHeight;

            ctx.clearRect(0, 0, trimTimelineCanvas.width, trimTimelineCanvas.height);

            // Draw simplified waveform (magnitude of movement)
            ctx.beginPath();
            ctx.strokeStyle = '#64748b';
            ctx.lineWidth = 1;

            const width = trimTimelineCanvas.width;
            const height = trimTimelineCanvas.height;

            if (trimDownsampledData.length === 0) return;

            // Calculate approximate displacement magnitude relative to start
            const startX = trimDownsampledData[0].x;
            const startY = trimDownsampledData[0].y;
            const startZ = trimDownsampledData[0].z;

            const values = trimDownsampledData.map(d => Math.sqrt((d.x-startX)**2 + (d.y-startY)**2 + (d.z-startZ)**2));
            const minVal = Math.min(...values);
            const maxVal = Math.max(...values);
            const range = maxVal - minVal || 1;

            trimDownsampledData.forEach((d, i) => {
                const x = (i / (trimDownsampledData.length - 1)) * width;
                const val = Math.sqrt((d.x-startX)**2 + (d.y-startY)**2 + (d.z-startZ)**2);
                const y = height - ((val - minVal) / range) * (height * 0.8) - (height * 0.1);
                if(i===0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
        }

        function renderMainChart() {
            const ctx = trimMainChartCanvas.getContext('2d');
            if(trimMainChart) trimMainChart.destroy();

            trimMainChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trimDownsampledData.map(d => d.t.toFixed(2)),
                    datasets: [
                        { label: 'X', data: trimDownsampledData.map(d => d.x), borderColor: '#ef4444', borderWidth: 1.5, pointRadius: 0 },
                        { label: 'Y', data: trimDownsampledData.map(d => d.y), borderColor: '#10b981', borderWidth: 1.5, pointRadius: 0 },
                        { label: 'Z', data: trimDownsampledData.map(d => d.z), borderColor: '#3b82f6', borderWidth: 1.5, pointRadius: 0 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { enabled: true }
                    },
                    scales: {
                        x: { display: true, title: { display: true, text: '時間 (s)' }, ticks: { maxTicksLimit: 10 } },
                        y: { display: true, title: { display: true, text: '変位 (mm or m)' } }
                    }
                }
            });
        }

        // Timeline Slider Logic
        function updateSliderPosition() {
            const totalT = trimTotalDuration;
            if (totalT <= 0) return;
            const startRatio = (trimStartTime - trimParsedData[0].t) / totalT;
            const endRatio = (trimEndTime - trimParsedData[0].t) / totalT;

            const startPct = Math.max(0, Math.min(100, startRatio * 100));
            const endPct = Math.max(0, Math.min(100, endRatio * 100));

            rangeOverlay.style.left = `${startPct}%`;
            rangeOverlay.style.width = `${endPct - startPct}%`;

            unselectedLeft.style.width = `${startPct}%`;
            unselectedRight.style.width = `${100 - endPct}%`;
        }

        function updateRangeFromInputs() {
            let start = parseFloat(trimStartTimeInput.value);
            let end = parseFloat(trimEndTimeInput.value);

            const minT = trimParsedData[0].t;
            const maxT = trimParsedData[trimParsedData.length-1].t;

            if(isNaN(start)) start = minT;
            if(isNaN(end)) end = maxT;

            start = Math.max(minT, Math.min(end, start));
            end = Math.min(maxT, Math.max(start, end));

            trimStartTime = start;
            trimEndTime = end;
            trimStartTimeInput.value = start.toFixed(3);
            trimEndTimeInput.value = end.toFixed(3);
            updateSliderPosition();
        }

        function startDragTimeline(e) {
            const rect = timelineSlider.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const ratio = x / rect.width;

            const totalT = trimTotalDuration;
            if (totalT <= 0) return;
            const currentStartRatio = (trimStartTime - trimParsedData[0].t) / totalT;
            const currentEndRatio = (trimEndTime - trimParsedData[0].t) / totalT;

            const threshold = 0.05; // handle hit area

            if (Math.abs(ratio - currentStartRatio) < threshold) {
                isDraggingHandle = 'left';
            } else if (Math.abs(ratio - currentEndRatio) < threshold) {
                isDraggingHandle = 'right';
            } else if (ratio > currentStartRatio && ratio < currentEndRatio) {
                isDraggingHandle = 'move';
                timelineSlider.dataset.dragStartRatio = ratio;
                timelineSlider.dataset.initialStartRatio = currentStartRatio;
                timelineSlider.dataset.initialEndRatio = currentEndRatio;
            } else {
                 if(ratio < currentStartRatio) isDraggingHandle = 'left';
                 else isDraggingHandle = 'right';
                 dragTimeline(e);
            }
        }

        function dragTimeline(e) {
            if(!isDraggingHandle) return;

            const rect = timelineSlider.getBoundingClientRect();
            let x = (e.clientX || e.touches[0].clientX) - rect.left;
            x = Math.max(0, Math.min(rect.width, x));
            const ratio = x / rect.width;

            const totalT = trimTotalDuration;
            const minT = trimParsedData[0].t;

            if (isDraggingHandle === 'left') {
                let newStart = minT + ratio * totalT;
                newStart = Math.min(newStart, trimEndTime);
                trimStartTime = newStart;
            } else if (isDraggingHandle === 'right') {
                let newEnd = minT + ratio * totalT;
                newEnd = Math.max(newEnd, trimStartTime);
                trimEndTime = newEnd;
            } else if (isDraggingHandle === 'move') {
                const startDragRatio = parseFloat(timelineSlider.dataset.dragStartRatio);
                const initialStartRatio = parseFloat(timelineSlider.dataset.initialStartRatio);
                const initialEndRatio = parseFloat(timelineSlider.dataset.initialEndRatio);
                const diff = ratio - startDragRatio;

                let newStartRatio = initialStartRatio + diff;
                let newEndRatio = initialEndRatio + diff;

                if(newStartRatio < 0) {
                    const offset = 0 - newStartRatio;
                    newStartRatio += offset;
                    newEndRatio += offset;
                }
                if(newEndRatio > 1) {
                    const offset = newEndRatio - 1;
                    newStartRatio -= offset;
                    newEndRatio -= offset;
                }

                trimStartTime = minT + newStartRatio * totalT;
                trimEndTime = minT + newEndRatio * totalT;
            }

            trimStartTimeInput.value = trimStartTime.toFixed(3);
            trimEndTimeInput.value = trimEndTime.toFixed(3);
            updateSliderPosition();
        }

        function stopDragTimeline() {
            isDraggingHandle = null;
        }

        function exportTrimmedData() {
            // Filter
            const filteredData = trimParsedData.filter(d => d.t >= trimStartTime && d.t <= trimEndTime);
            if(filteredData.length === 0) {
                alert('選択範囲にデータがありません。');
                return;
            }

            // Reconstruct CSV using original lines for maximum fidelity
            // We use originalLineIndex to fetch line from trimRawData
            const headerSection = trimHeaderLines.join('\n');
            const dataSection = filteredData.map(d => trimRawData[d.originalLineIndex]).join('\n');

            const finalCSV = headerSection + '\n' + dataSection;

            const blob = new Blob([finalCSV], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `trimmed_${trimStartTime.toFixed(2)}-${trimEndTime.toFixed(2)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- DATA ANALYSIS TOOL SCRIPT (Previous Code Reuse) ---
        // (Skipping for brevity as this is a test file for trimming)
    });
</script>
</body>
</html>