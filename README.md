# Mocap Plus | モーションキャプチャ統合解析ツール

## 概要

**Mocap Plus**は、モーションキャプチャ「OptiTrack」の解析ソフトウェア「Motive」からエクスポートされたCSVファイルをブラウザにドラッグ＆ドロップするだけで、各種データ解析を自動で行い、結果をグラフで可視化するWebアプリケーションです。

本ツールは、中央大学 國井研究室におけるモーションキャプチャのデータ解析を効率化することを目的として開発されました。

**ご利用はこちらから:** [https://minoru-saito-chuo.github.io/mocap/](https://minoru-saito-chuo.github.io/mocap/)


## 主な機能

* **データ解析ツール**:
    * MotiveからエクスポートしたCSVファイルを複数同時に解析
    * 剛体の動作区間を自動で検出し、静止部分をカット
    * 速度、スリップ率、鉛直変位、平面軌跡などを自動で計算・グラフ化
    * ローパスフィルタによるノイズ除去機能
    * グラフのスタイル（カジュアル/フォーマル）切り替え
    * グラフの画像（PNG/PDF）および詳細データのCSVエクスポート機能

* **基準速度算出ツール**:
    * 車輪などの回転データから、スリップ率の計算に必要な基準速度を算出
    * 回転周期を自動で検出し、半径を入力するだけで周速度を計算

## 使い方

### データ解析ツール

1.  **ファイルの選択**: MotiveからエクスポートしたCSVファイルを1つ以上選択します。
2.  **パラメータの設定**:
    * **基準速度**: スリップ率の算出に用いる基準速度（車輪の周速度など）を各ファイルごとに入力します。
    * **方向の定義**: 解析対象の座標系における「進行方向」と「鉛直方向」を定義します。
3.  **解析対象の選択**: ファイル内に含まれる剛体の一覧から、解析したいものを選択します。グラフの凡例名もここで編集できます。
4.  **解析開始**: 「解析開始」ボタンを押すと、計算が実行され、平均値やグラフなどの結果が表示されます。
5.  **結果の調整とエクスポート**:
    * 必要に応じて、微小速度のフィルタリングやローパスフィルタを適用し、結果を再計算・再描画できます。
    * グラフのタイトルや軸ラベルを編集し、PNGまたはPDF形式でダウンロードできます。

### 基準速度算出ツール

1.  **ファイルの選択**: 無負荷状態で回転させた車輪などの剛体のCSVデータを選択します。
2.  **パラメータの設定**:
    * **剛体の選択**: 回転を計測したい剛体を選択します。
    * **半径の入力**: 剛体の半径をcm単位で入力します。
    * **回転軸の選択**: 剛体が回転する軸を選択します。
3.  **計算開始**: ボタンを押すと、回転周期が算出され、基準となる周速度が表示されます。

## アルゴリズム仕様

本ツールで採用されているデータ解析のアルゴリズムおよび計算式について、その詳細を以下に示します。

### データ解析ツール

#### 動作区間の自動検出
本ツールでは、CSVデータに含まれる時間全体のデータから、対象物が実際に動作している区間を自動で抽出します。この処理は、ユーザーが指定した「進行方向」の座標データに基づいて行われます。
まず、進行方向軸における全データの最大値 $P_{max}$ と最小値 $P_{min}$ から、全体の振れ幅 $R$ を計算します。

$$R = P_{max} - P_{min}$$

次に、この振れ幅 $R$ とユーザーが設定可能な「静止範囲の倍率」$M$（デフォルト値: 0.001）を用いて、静止判定の閾値となるマージン $\\delta$ を決定します。

$$\\delta = R \\times M$$

このマージン $\\delta$ を用いて、データの初期値 $P_{initial}$ から $\\pm \\delta$ の範囲を逸脱した最初のフレームを「動作開始点」、データの最終値 $P_{final}$ から $\\pm \\delta$ の範囲に最初に入ったフレームを「動作終了点」として検出し、その間の区間を解析対象とします。

![動作区間検出の概念図](img/exp.png)

#### 水平移動距離
各時刻 $t$ における水平移動距離 $d(t)$ は、ユーザーが定義した「鉛直方向」以外の2軸（水平軸 $h_1, h_2$）の変位から算出されます。動作開始点の座標を $(h_{1,0}, h_{2,0})$ とすると、時刻 $t$ での座標 $(h_{1,t}, h_{2,t})$ との間の距離は、三平方の定理を用いて次式で計算されます。

$$d(t) = \\sqrt{(h_{1,t} - h_{1,0})^2 + (h_{2,t} - h_{2,0})^2}$$

#### 瞬時速度（微小速度）
時刻 $t_i$ における瞬時速度 $v_i$ は、隣接するフレーム間の水平移動距離と時間の変化量から、後退差分を用いて近似的に算出されます。

$$v_i = \\frac{d(t_i) - d(t_{i-1})}{t_i - t_{i-1}} = \\frac{\\Delta d}{\\Delta t}$$

#### スリップ率
スリップ率 $S$ は、ユーザーが入力した基準速度 $u$ と、算出した剛体の速度 $v$ を用いて計算されます。$u > v$ の場合は駆動輪のスリップ（加速時）、$u < v$ の場合は制動輪のスリップ（減速時）として、以下の式で定義されます。

$$S [\\%] = 
\\begin{cases} 
(1 - \\frac{v}{u}) \\times 100 & (u > v, \\text{ 加速スリップ}) \\\\
(1 - \\frac{u}{v}) \\times 100 & (u < v, \\text{ 制動スリップ}) 
\\end{cases}$$

#### 分散
速度およびスリップ率のばらつきを示す指標として、標本分散 $\\sigma^2$ と不偏分散 $u^2$ の2種類を算出しています。データ数 $n$、個々のデータ値 $x_i$、平均値 $\\bar{x}$ を用いて、それぞれ以下の式で計算されます。

$$
\\text{標本分散: } \\sigma^2 = \\frac{1}{n} \\sum_{i=1}^{n} (x_i - \\bar{x})^2
$$

$$
\\text{不偏分散: } u^2 = \\frac{1}{n-1} \\sum_{i=1}^{n} (x_i - \\bar{x})^2
$$

#### ローパスフィルタ
グラフのノイズを低減するために、単純移動平均（Simple Moving Average）によるローパスフィルタを実装しています。ユーザーが指定した平滑化の度合い（ウィンドウサイズ $W$）に基づき、ある点 $i$ の値 $y_i$ を、その前後 $\\lfloor W/2 \\rfloor$ 個のデータを含む合計 $W$ 個のデータの平均値 $\\hat{y}_i$ で置き換えます。

$$\\hat{y}_i = \\frac{1}{W} \\sum_{j=i-\\lfloor W/2 \\rfloor}^{i+\\lfloor W/2 \\rfloor} y_j$$

### 基準速度算出ツール

#### 角度データのアンラップ
Motiveから出力される回転角度データは、通常 $\\pm 180^\\circ$ の範囲に制限されており、回転がこの範囲を超えると値が不連続に変化（ラップ）します。正確な周期計算のため、このラップを解消（アンラップ）し、連続的な角度変化データに変換します。具体的には、隣接する角度データ $A_{i-1}$ と $A_i$ の差が $\\pm 180^\\circ$ を超えた場合に、$360^\\circ$ のオフセットを加算または減算して補正します。

$$
A'_{i} = 
\\begin{cases} 
A'_{i-1} + (A_i - A_{i-1}) - 360 & (A_i - A_{i-1} > 180^\\circ) \\\\
A'_{i-1} + (A_i - A_{i-1}) + 360 & (A_i - A_{i-1} < -180^\\circ) \\\\
A'_{i-1} + (A_i - A_{i-1}) & (\\text{その他})
\\end{cases}
$$

#### 回転周期の算出
アンラップされた角度データから、車輪が1回転（$360^\\circ$）するのに要する時間（周期 $T$）を算出します。まず、回転が開始したと見なされる点（初期角度から $5^\\circ$ 以上変化した点）を検出し、その時刻 $t_{start}$ と角度 $A_{start}$ を記録します。次に、角度が $A_{start} \\pm 360^\\circ$ に到達する時刻 $t_{end}$ を探します。
目標角度を跨ぐ2つのフレーム間で線形補間を行い、正確な到達時刻 $t_{end}$ を推定します。目標角度 $A_{target}$ を跨ぐ直前と直後の点をそれぞれ $(t_{before}, A_{before})$, $(t_{after}, A_{after})$ とした場合、到達時刻 $t_{end}$ は以下の線形補間の式で求められます。

$$
t_{end} = t_{before} + (t_{after} - t_{before}) \\times \\frac{A_{target} - A_{before}}{A_{after} - A_{before}}
$$

最終的な周期 $T$ は以下の式で得られます。

$$T = t_{end} - t_{start}$$

#### 基準速度の算出
算出された周期 $T$ と、ユーザーが入力した車輪の半径 $r$ から、車輪の周速度、すなわち基準速度 $v$ を計算します。角速度 $\\omega$ は $\\omega = 2\\pi / T$ で与えられるため、基準速度 $v$ は次式で求められます。

$$v = r \\cdot \\omega = \\frac{2\\pi r}{T}$$

## 注意事項
* 本ツールは、OptiTrackの解析ソフト「Motive」からエクスポートされたCSVファイルに最適化されています。
* データ処理は全てブラウザ内で完結し、添付したデータが外部に送信されることはありません。
* 本ツールの利用によって生じた直接的または間接的な損害について、製作者は一切責任を負いません。
* 本ツールの作成にあたっては、複数のLLMを利用しています。

## 動作環境
本ツールは、以下のモダンブラウザで動作確認済みです。
* Google Chrome
* Microsoft Edge

## 製作者
中央大学 理工学部 電気電子情報通信工学科 國井研究室
西藤 実 (SAITO Minoru)